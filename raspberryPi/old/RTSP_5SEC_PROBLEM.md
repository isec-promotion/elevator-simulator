# RTSP 5 ç§’ã§é€”åˆ‡ã‚Œã‚‹å•é¡Œã®è§£æ±º

## ğŸ” å•é¡Œã®åŸå› 

VLC ã§ RTSP æ¥ç¶šãŒ 5 ç§’ã§é€”åˆ‡ã‚Œã‚‹å•é¡Œã¯ã€é™æ­¢ç”»ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ã§ã‚ˆãã‚ã‚‹å•é¡Œã§ã™ã€‚

### ä¸»ãªåŸå› 

1. **é™æ­¢ç”»ã®ç„¡é™ãƒ«ãƒ¼ãƒ—å•é¡Œ**

   - FFmpeg ã® `-loop 1` ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§é™æ­¢ç”»ã‚’ç„¡é™ãƒ«ãƒ¼ãƒ—ã—ã¦ã„ã‚‹ãŒã€å®Ÿéš›ã«ã¯æœ‰é™ã®æ™‚é–“ã§çµ‚äº†ã™ã‚‹
   - ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ç´„ 5 ç§’ç¨‹åº¦ã§ã‚¹ãƒˆãƒªãƒ¼ãƒ ãŒçµ‚äº†ã—ã¦ã—ã¾ã†

2. **ã‚­ãƒ¼ãƒ•ãƒ¬ãƒ¼ãƒ è¨­å®šã®å•é¡Œ**

   - H.264 ã‚¨ãƒ³ã‚³ãƒ¼ãƒ€ã®ã‚­ãƒ¼ãƒ•ãƒ¬ãƒ¼ãƒ é–“éš”ãŒé©åˆ‡ã§ãªã„
   - VLC ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒã‚¹ãƒˆãƒªãƒ¼ãƒ ã®ç¶™ç¶šæ€§ã‚’èªè­˜ã§ããªã„

3. **ãƒ“ãƒƒãƒˆãƒ¬ãƒ¼ãƒˆåˆ¶å¾¡ã®å•é¡Œ**

   - é™æ­¢ç”»ã§ã¯å®Ÿéš›ã®ãƒ“ãƒƒãƒˆãƒ¬ãƒ¼ãƒˆãŒéå¸¸ã«ä½ããªã‚‹
   - ã‚¹ãƒˆãƒªãƒ¼ãƒ ãŒã€Œçµ‚äº†ã—ãŸã€ã¨åˆ¤æ–­ã•ã‚Œã‚‹

4. **RTSP ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ã®å•é¡Œ**
   - RTSP ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®š
   - ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãƒ»ã‚µãƒ¼ãƒãƒ¼é–“ã®ã‚­ãƒ¼ãƒ—ã‚¢ãƒ©ã‚¤ãƒ–ãŒä¸ååˆ†

## ğŸ› ï¸ è§£æ±ºç­–

### 1. å‹•çš„ç”»åƒæ›´æ–°ï¼ˆæ¨å¥¨ï¼‰

**æ–¹æ³•**: ç”»åƒã‚’å®šæœŸçš„ã«æ›´æ–°ã—ã¦ã€Œå‹•ç”»ã€ã¨ã—ã¦èªè­˜ã•ã›ã‚‹

```python
# rtsp_continuous_test.py ã®æ–¹æ³•
def update_image_continuously():
    while True:
        create_dynamic_image()  # æ™‚åˆ»ä»˜ãç”»åƒã‚’ç”Ÿæˆ
        time.sleep(1)  # 1ç§’ã”ã¨ã«æ›´æ–°
```

**åŠ¹æœ**:

- âœ… ã‚¹ãƒˆãƒªãƒ¼ãƒ ãŒç¶™ç¶šçš„ã«æ›´æ–°ã•ã‚Œã‚‹
- âœ… VLC ãŒã€Œãƒ©ã‚¤ãƒ–ã‚¹ãƒˆãƒªãƒ¼ãƒ ã€ã¨ã—ã¦èªè­˜
- âœ… 5 ç§’ã§é€”åˆ‡ã‚Œã‚‹å•é¡Œã‚’è§£æ±º

### 2. FFmpeg ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®æœ€é©åŒ–

#### é€£ç¶š RTSP ç”¨ã®è¨­å®š

```bash
ffmpeg -re -f image2 -loop 1 -r 30 -i /tmp/rtsp_live.jpg \
    -c:v libx264 -preset ultrafast -tune stillimage \
    -pix_fmt yuv420p \
    -g 30 -keyint_min 30 -sc_threshold 0 \
    -b:v 2000k -maxrate 2000k -bufsize 4000k \
    -f rtsp -rtsp_transport tcp \
    rtsp://0.0.0.0:8554/live
```

**é‡è¦ãªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿**:

- `-g 30`: ã‚­ãƒ¼ãƒ•ãƒ¬ãƒ¼ãƒ é–“éš”ã‚’ 30 ãƒ•ãƒ¬ãƒ¼ãƒ ã«è¨­å®š
- `-keyint_min 30`: æœ€å°ã‚­ãƒ¼ãƒ•ãƒ¬ãƒ¼ãƒ é–“éš”
- `-sc_threshold 0`: ã‚·ãƒ¼ãƒ³ãƒã‚§ãƒ³ã‚¸æ¤œå‡ºã‚’ç„¡åŠ¹åŒ–
- `-rtsp_transport tcp`: TCP ãƒˆãƒ©ãƒ³ã‚¹ãƒãƒ¼ãƒˆã‚’ä½¿ç”¨ï¼ˆã‚ˆã‚Šå®‰å®šï¼‰

#### å‹•ç”»å½¢å¼ç”¨ã®è¨­å®š

```bash
ffmpeg -f image2 -r 1 -i /tmp/rtsp_live.jpg \
    -c:v libx264 -preset ultrafast -tune stillimage \
    -pix_fmt yuv420p -r 30 \
    -g 60 -keyint_min 60 \
    -x264-params keyint=60:min-keyint=60:scenecut=-1 \
    -b:v 2000k -maxrate 2000k -bufsize 4000k \
    -f rtsp -rtsp_transport tcp \
    rtsp://0.0.0.0:8554/video
```

### 3. VLC ã‚µãƒ¼ãƒãƒ¼è¨­å®šã®æœ€é©åŒ–

```bash
cvlc --intf dummy --loop --image-duration 1 /tmp/rtsp_live.jpg \
    --sout '#transcode{vcodec=h264,vb=2000,fps=30,keyint=60}:rtp{sdp=rtsp://0.0.0.0:8554/vlc}'
```

**é‡è¦ãªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿**:

- `--image-duration 1`: ç”»åƒã®è¡¨ç¤ºæ™‚é–“ã‚’ 1 ç§’ã«è¨­å®š
- `keyint=60`: ã‚­ãƒ¼ãƒ•ãƒ¬ãƒ¼ãƒ é–“éš”ã‚’ 60 ãƒ•ãƒ¬ãƒ¼ãƒ ã«è¨­å®š

### 4. GStreamer è¨­å®šã®æœ€é©åŒ–

```bash
gst-launch-1.0 -v multifilesrc location=/tmp/rtsp_live.jpg loop=true \
    caps=image/jpeg,framerate=30/1 ! jpegdec ! videoconvert ! videoscale ! \
    video/x-raw,width=1920,height=1080,framerate=30/1 ! \
    x264enc tune=zerolatency bitrate=2000 speed-preset=ultrafast key-int-max=60 ! \
    rtph264pay config-interval=1 pt=96 ! \
    udpsink host=0.0.0.0 port=8554 auto-multicast=true
```

## ğŸ“‹ Raspberry Pi ã§ã®å®Ÿè¡Œæ‰‹é †

### ã‚¹ãƒ†ãƒƒãƒ— 1: é€£ç¶šã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œ

```bash
# Raspberry Pi ã§å®Ÿè¡Œ
cd /path/to/elevator-simulator/raspberryPi
python3 rtsp_continuous_test.py
```

### ã‚¹ãƒ†ãƒƒãƒ— 2: æ–¹æ³•ã®é¸æŠ

```
1. FFmpeg é€£ç¶šRTSP (æ¨å¥¨)
2. FFmpeg å‹•ç”»å½¢å¼RTSP
3. VLC é€£ç¶šRTSP
4. GStreamer é€£ç¶šUDP
```

**æ¨å¥¨**: æ–¹æ³• 1ï¼ˆFFmpeg é€£ç¶š RTSPï¼‰ã‚’é¸æŠ

### ã‚¹ãƒ†ãƒƒãƒ— 3: VLC ã§ã®æ¥ç¶š

```
rtsp://192.168.40.239:8554/live
```

### ã‚¹ãƒ†ãƒƒãƒ— 4: å‹•ä½œç¢ºèª

- âœ… ç”»åƒã«æ™‚åˆ»ãŒè¡¨ç¤ºã•ã‚Œã‚‹
- âœ… 1 ç§’ã”ã¨ã«æ™‚åˆ»ãŒæ›´æ–°ã•ã‚Œã‚‹
- âœ… 5 ç§’çµŒã£ã¦ã‚‚æ˜ åƒãŒé€”åˆ‡ã‚Œãªã„
- âœ… é•·æ™‚é–“ã®é€£ç¶šå†ç”ŸãŒå¯èƒ½

## ğŸ”§ ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### å•é¡Œ: ã¾ã  5 ç§’ã§é€”åˆ‡ã‚Œã‚‹

**è§£æ±ºç­–**:

1. ç”»åƒæ›´æ–°ã‚¹ãƒ¬ãƒƒãƒ‰ãŒæ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã‚‹ã‹ç¢ºèª
2. FFmpeg ã®ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ã‚¨ãƒ©ãƒ¼ãŒãªã„ã‹ãƒã‚§ãƒƒã‚¯
3. VLC ã®è¨­å®šã§ã€Œãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã€ã‚’å¢—ã‚„ã™

### å•é¡Œ: ç”»åƒãŒæ›´æ–°ã•ã‚Œãªã„

**è§£æ±ºç­–**:

1. `/tmp/rtsp_live.jpg` ãƒ•ã‚¡ã‚¤ãƒ«ã®æ¨©é™ã‚’ç¢ºèª
2. Python ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ãƒ­ã‚°ã‚’ç¢ºèª
3. ç”»åƒæ›´æ–°ã‚¹ãƒ¬ãƒƒãƒ‰ã®ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’ç¢ºèª

### å•é¡Œ: CPU ä½¿ç”¨ç‡ãŒé«˜ã„

**è§£æ±ºç­–**:

1. ç”»åƒæ›´æ–°é–“éš”ã‚’é•·ãã™ã‚‹ï¼ˆ1 ç§’ â†’3 ç§’ï¼‰
2. FFmpeg ã® `-preset` ã‚’ `ultrafast` ã‹ã‚‰ `fast` ã«å¤‰æ›´
3. è§£åƒåº¦ã‚’ä¸‹ã’ã‚‹ï¼ˆ1920x1080â†’1280x720ï¼‰

## ğŸ“Š å„æ–¹æ³•ã®æ¯”è¼ƒ

| æ–¹æ³•             | å®‰å®šæ€§     | CPU ä½¿ç”¨ç‡ | è¨­å®šã®ç°¡å˜ã• | æ¨å¥¨åº¦     |
| ---------------- | ---------- | ---------- | ------------ | ---------- |
| FFmpeg é€£ç¶š RTSP | â­â­â­â­â­ | â­â­â­     | â­â­â­â­     | â­â­â­â­â­ |
| FFmpeg å‹•ç”»å½¢å¼  | â­â­â­â­   | â­â­â­â­   | â­â­â­       | â­â­â­â­   |
| VLC é€£ç¶š RTSP    | â­â­â­     | â­â­       | â­â­â­       | â­â­â­     |
| GStreamer UDP    | â­â­       | â­â­â­     | â­â­         | â­â­       |

## ğŸ¯ æœ¬ç•ªç’°å¢ƒã¸ã®é©ç”¨

### elevator_display_streamer_fixed.py ã®ä¿®æ­£

å…ƒã®ã‚¨ãƒ¬ãƒ™ãƒ¼ã‚¿ãƒ¼è¡¨ç¤ºã‚·ã‚¹ãƒ†ãƒ ã«é€£ç¶šã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°æ©Ÿèƒ½ã‚’é©ç”¨ã™ã‚‹å ´åˆï¼š

```python
def create_display_image(self):
    # æ—¢å­˜ã®ç”»åƒç”Ÿæˆã‚³ãƒ¼ãƒ‰
    # ...

    # æ™‚åˆ»æƒ…å ±ã‚’è¿½åŠ ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
    current_time = datetime.now().strftime("%H:%M:%S")
    time_font = ImageFont.truetype("/usr/share/fonts/truetype/dejavu/DejaVuSans.ttf", 40)
    draw.text((50, 50), current_time, fill='#333333', font=time_font)

    img.save(self.image_path, 'JPEG', quality=95)
```

### FFmpeg ã‚³ãƒãƒ³ãƒ‰ã®ä¿®æ­£

```python
def start_ffmpeg_rtsp_server(self):
    ffmpeg_cmd = [
        'ffmpeg', '-re', '-f', 'image2', '-loop', '1', '-r', '30',
        '-i', self.image_path,
        '-c:v', 'libx264', '-preset', 'ultrafast', '-tune', 'stillimage',
        '-pix_fmt', 'yuv420p',
        '-g', '30', '-keyint_min', '30', '-sc_threshold', '0',
        '-b:v', '2000k', '-maxrate', '2000k', '-bufsize', '4000k',
        '-f', 'rtsp', '-rtsp_transport', 'tcp',
        f'rtsp://0.0.0.0:{self.rtsp_port}/live'
    ]
```

## ğŸ‰ ã¾ã¨ã‚

### 5 ç§’ã§é€”åˆ‡ã‚Œã‚‹å•é¡Œã®è§£æ±ºæ–¹æ³•

1. **å‹•çš„ç”»åƒæ›´æ–°**: ç”»åƒã‚’å®šæœŸçš„ã«æ›´æ–°ã—ã¦ãƒ©ã‚¤ãƒ–ã‚¹ãƒˆãƒªãƒ¼ãƒ ã¨ã—ã¦èªè­˜ã•ã›ã‚‹
2. **FFmpeg ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æœ€é©åŒ–**: ã‚­ãƒ¼ãƒ•ãƒ¬ãƒ¼ãƒ é–“éš”ã¨ãƒ“ãƒƒãƒˆãƒ¬ãƒ¼ãƒˆåˆ¶å¾¡ã‚’é©åˆ‡ã«è¨­å®š
3. **TCP ãƒˆãƒ©ãƒ³ã‚¹ãƒãƒ¼ãƒˆä½¿ç”¨**: UDP ã‚ˆã‚Šå®‰å®šã—ãŸ TCP ã‚’ä½¿ç”¨
4. **é€£ç¶šã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°**: ç„¡é™ãƒ«ãƒ¼ãƒ—ã§ã¯ãªãã€å®Ÿéš›ã®é€£ç¶šã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’ç”Ÿæˆ

### æ¨å¥¨è¨­å®š

- **æ–¹æ³•**: FFmpeg é€£ç¶š RTSP
- **ç”»åƒæ›´æ–°**: 1 ç§’é–“éš”
- **è§£åƒåº¦**: 1920x1080
- **ãƒ“ãƒƒãƒˆãƒ¬ãƒ¼ãƒˆ**: 2000kbps
- **ãƒˆãƒ©ãƒ³ã‚¹ãƒãƒ¼ãƒˆ**: TCP

ã“ã®è¨­å®šã«ã‚ˆã‚Šã€VLC ã§å®‰å®šã—ãŸé•·æ™‚é–“ã® RTSP ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚
